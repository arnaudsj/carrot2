<project name="carrot2.workbench" default="build">
  <!-- Basedir relative to this build file -->
  <dirname property="carrot2.master.basedir" file="${ant.file.carrot2.workbench}"/>

  <!-- Import local properties and version -->
  <property file="${carrot2.master.basedir}/local.properties" />

  <property file="${carrot2.master.basedir}/etc/version/carrot2.version" />
  <property file="${carrot2.master.basedir}/etc/version/carrot2.basenames" /> 

  <property name="dist.dir" location="${carrot2.master.basedir}/tmp/dist" />

  <property name="workbench.properties" location="${carrot2.master.basedir}/workbench.properties" />
  <property file="${workbench.properties}" />
  <property file="${carrot2.master.basedir}/workbench/build-conf/build.properties" />

  <property name="workbench.build.dir" location="tmp/workbench" />
  <property name="workbench.tests.html.report.dir" location="${workbench.build.dir}/test-report" />
  <property name="workbench.tests.txt.report.dir"  location="${workbench.build.dir}/test-report-txt" />

  <import file="${carrot2.master.basedir}/lib/org.carrot2.antlib/build.xml" />
  <import file="${carrot2.master.basedir}/etc/ant/common/readme.xml" />

  <patternset id="temporary.files">
    <exclude name="**/.svn/**" />
    <exclude name="**/tmp/**" />
    <exclude name="**/.clover/**" />
  </patternset>

  <!-- Macros -->
  <macrodef name="launchAntRunner">
    <attribute name="buildfile" />
    <attribute name="build.dir" />
    <attribute name="props.file" default="${carrot2.master.basedir}/workbench.properties" />
    <attribute name="extra.args" default="" />
    <sequential>
      <java jar="${eclipse.home}/plugins/${equinox.launcher.plugin.jar}"
            fork="true" failonerror="true">
        <arg line="-application org.eclipse.ant.core.antRunner" />
        <arg line="-buildfile @{buildfile}" />
        <arg line="-Dbuilder=${carrot2.master.basedir}/workbench/build-conf/" />
        <arg line="-DbuildDirectory=@{build.dir}" />
        <arg line="-Dtarget.platform=${target.platform}" />
        <arg line="-Dcarrot2.master.basedir=${carrot2.master.basedir}" />
        <arg line="-Dcarrot2.version=${carrot2.version}" />
        <arg line="-Dcarrot2.workbench.base=${carrot2.workbench.base}" />
        <arg line="@{extra.args}" />
        <arg line="-propertyfile @{props.file}" />
      </java>
    </sequential>
  </macrodef>

  <macrodef name="checkAccessRestriction">
    <attribute name="logsBasedir" />
    <sequential>
      <fail message="Access Restriction errors during build! Are you sure all packages are visible at runtime?">
        <condition>
          <resourcecount when="greater" count="0">
            <fileset dir="@{logsBasedir}">
              <include name="**/compilelogs/**" />
              <contains text="Access restriction" />
            </fileset>
          </resourcecount>
        </condition>
      </fail>
    </sequential>
  </macrodef>

  <!-- Initialize the build. -->
  <target name="init" depends="carrot2.common.antlib.tasks">
    <findVersion property="equinox.launcher.plugin.jar"
                 eclipsehome="${eclipse.home}"
                 pluginid="org.eclipse.equinox.launcher"
                 pluginform="jar" />

    <findVersion property="pde.build.plugin"
                 eclipsehome="${eclipse.home}"
                 pluginid="org.eclipse.pde.build"
                 pluginform="dir" />

    <echo>Equinox version: ${equinox.launcher.plugin.jar}, PDE build plugin: ${pde.build.plugin}</echo>
    
    <!-- Compute attribute metadata. -->
    <ant antfile="${carrot2.master.basedir}/build.xml" target="attrs" />

    <!-- Copy source plugins and features to the build folder. -->
    <copy todir="${workbench.build.dir}/plugins">
      <fileset dir="${carrot2.master.basedir}">
        <include name="core/**" />
        <include name="lib/**" />
        <include name="workbench/**" />
        <exclude name="**/*.feature/**" />
        <patternset refid="temporary.files" />
      </fileset>

      <regexpmapper from="[^/]+/(.*)" to="\1" handledirsep="yes" />
    </copy>

    <copy todir="${workbench.build.dir}/plugins" overwrite="true" filtering="true">
      <fileset dir="${carrot2.master.basedir}">
        <include name="core/**/MANIFEST.MF" />
        <include name="lib/**/MANIFEST.MF" />
        <include name="workbench/**/MANIFEST.MF" />
        <exclude name="**/*.feature/**" />
        <patternset refid="temporary.files" />
      </fileset>

      <regexpmapper from="[^/]+/(.*)" to="\1" handledirsep="yes" />

      <filterchain id="workbench.version.filterchain">
        <replacestring from="0.0.0.QUALIFIER" to="${carrot2.version.workbench}"/>
      </filterchain>
    </copy>

    <copy todir="${workbench.build.dir}/features">
      <fileset dir="${carrot2.master.basedir}/workbench">
        <patternset refid="temporary.files" />
        <include name="**/*.feature/**" />
      </fileset>
    </copy>

    <copy todir="${workbench.build.dir}/features" overwrite="true" filtering="true">
      <fileset dir="${carrot2.master.basedir}/workbench">
        <include name="**/*.feature/**/feature.xml" />
        <include name="**/*.feature/**/MANIFEST.MF" />
        <patternset refid="temporary.files" />
      </fileset>
      
      <filterchain refid="workbench.version.filterchain" />
    </copy>
  </target>


  <!-- Build the workbench. -->
  <target name="build" description="Build the workbench" depends="init">
    <!-- Compile and assemble the workbench. -->
    <launchAntRunner buildfile="${eclipse.home}/plugins/${pde.build.plugin}/scripts/productBuild/productBuild.xml"
                     build.dir="${workbench.build.dir}"
                     props.file="${carrot2.master.basedir}/workbench.properties"
                     extra.args="
                        -Dproduct=/org.carrot2.workbench.feature/Workbench.product" />

    <checkAccessRestriction logsbasedir="${workbench.build.dir}" />
  </target>


  <!-- Build the test distribution and run the tests. -->
  <target name="test" description="Builds workbench and run the tests" depends="init">
    <!-- Compile and assemble the test distribution. -->
    <launchAntRunner buildfile="${eclipse.home}/plugins/${pde.build.plugin}/scripts/productBuild/productBuild.xml"
                     build.dir="${workbench.build.dir}"
                     props.file="${carrot2.master.basedir}/workbench.properties"
                     extra.args="
                        -DbuildType=T
                        -Dproduct=/org.carrot2.workbench.feature/Workbench.product 
                        -DfeatureList=org.carrot2.workbench.core.test.feature
                        -Dconfigs=${test.os},${test.ws},${test.arch}
                        -DarchivesFormat=${test.os},${test.ws},${test.arch}-folder" />

    <checkAccessRestriction logsbasedir="${workbench.build.dir}" />

    <property name="test.eclipse.home" 
        location="${workbench.build.dir}/tmp/${archivePrefix}" />

    <findVersion property="workbench.core.test.dir"
                 pluginid="org.carrot2.workbench.core.test"
                 pluginform="dir"
                 eclipsehome="${test.eclipse.home}" />

    <property name="org.carrot2.antlib" location="lib/org.carrot2.antlib" />
    <java jar="${eclipse.home}/plugins/${equinox.launcher.plugin.jar}" fork="true" failonerror="true">
      <arg line="-application org.eclipse.ant.core.antRunner" />
      <arg line="-buildfile ${test.eclipse.home}/plugins/${workbench.core.test.dir}/test.xml" />
      <arg line="-Declipse-home=${test.eclipse.home}" />
      <arg line="-Dorg.carrot2.antlib=${org.carrot2.antlib}" />
      <arg line="-Dos=${test.os} -Dws=${test.ws} -Darch=${test.arch}" />
    </java>

    <!-- JUnit report -->
    <mkdir dir="${workbench.tests.html.report.dir}" />
    <junitreport todir="${workbench.tests.html.report.dir}">
      <fileset dir="${workbench.build.dir}/tmp/${archivePrefix}">
        <include name="*.xml" />
      </fileset>
      <report format="frames"
              todir="${workbench.tests.html.report.dir}" />
    </junitreport>

    <!-- Copy XML reports -->
    <copy todir="${workbench.tests.html.report.dir}">
      <fileset dir="${workbench.build.dir}/tmp/${archivePrefix}">
        <include name="*.xml" />
      </fileset>
      <mapper type="glob" from="*.xml" to="TEST-*.xml" />
    </copy>

    <!-- Copy text reports -->
    <mkdir dir="${workbench.tests.txt.report.dir}" />
    <copy todir="${workbench.tests.txt.report.dir}">
      <fileset dir="${workbench.build.dir}/tmp/${archivePrefix}/raw-output">
        <include name="*.txt" />
      </fileset>
    </copy>

    <!-- 
        A hacky way of finding out whether tests passed. The Eclipse runner doesn't
        seem to expose this information directly.
      -->
    <loadfile property="testxml"
              srcFile="${workbench.tests.html.report.dir}/TESTS-TestSuites.xml" />
    <fail message="Tests failed, see ${workbench.tests.html.report.dir} for report.">
      <condition>
          <matches string="${testxml}" pattern="(failures|errors)=.[1-9][0-9]*" />
      </condition>
    </fail>
    <fail message="Tests did not run, see ${workbench.tests.txt.report.dir} for logs.">
      <condition>
          <matches string="${testxml}" pattern="testsuites />" />
      </condition>
    </fail>
  </target>

  <target name="clean">
    <delete dir="${workbench.build.dir}" failonerror="false" />
  </target>

  <!--
       Prepares Workbench archives for distribution.
    -->
  <target name="dist" depends="build">
    <taskdef resource="net/sf/antcontrib/antlib.xml">
      <classpath>
        <pathelement location="${carrot2.master.basedir}/etc/ant/ant-contrib-1.0b3.jar" />
      </classpath>
    </taskdef>

    <mkdir dir="${dist.dir}" />
    <copy todir="${dist.dir}" overwrite="true">
      <fileset dir="${workbench.build.dir}">
        <include name="**/${carrot2.workbench.base}*.zip" />
      </fileset>

      <chainedmapper>
        <mapper type="flatten" />
        <mapper type="glob" from="*.zip" to="*-${carrot2.version}.zip"/>
      </chainedmapper>
    </copy>

    <!-- Add readme.txt files -->
    <mkdir dir="${carrot2.master.basedir}/tmp/workbench/readme" />
    <carrot2.readme readme.src="${carrot2.master.basedir}/workbench/org.carrot2.workbench.feature/readme.txt"
                    readme.dest="${carrot2.master.basedir}/tmp/workbench/readme/readme.txt" />
    <for param="zip">
      <fileset dir="${dist.dir}">
        <include name="${carrot2.workbench.base}*.zip" />
      </fileset>

      <sequential>
        <zip destfile="@{zip}" update="true">
          <zipfileset dir="${carrot2.master.basedir}/tmp/workbench/readme" prefix="${carrot2.workbench.base}-${carrot2.version}">
            <include name="readme.txt" />
          </zipfileset>
        </zip>  
      </sequential>
    </for>
    <delete dir="${carrot2.master.basedir}/tmp/workbench/readme" />
  </target>
</project>
